{% extends "base.html" %}
{% block content %}
  <form action="/preview" method="post">
    <label for="prompt">DÃ©cris ton projet :</label>
    <textarea id="prompt" name="prompt" rows="6" placeholder="Ex: API FastAPI avec users(email unique, password_hash) et products(name, price:float, category), Postgres, JWT, tests CRUD, CI GitHub, docker prÃªt."></textarea>
    
    <label for="name">Nom du projet (slug) :</label>
    <input id="name" name="name" placeholder="ex: fleet-api" />
    
    <!-- NEW: Choix du mode LLM -->
    <label for="llm_mode">Mode de gÃ©nÃ©ration :</label>
    <div class="llm-selector">
      <div class="llm-option">
        <input type="radio" id="llm_mock" name="llm_mode" value="mock" checked>
        <label for="llm_mock" class="llm-label">
          <span class="llm-name">âš¡ Fallback DÃ©terministe</span>
          <span class="llm-desc">Ultra-rapide (0.03s), 100% fiable, gratuit</span>
          <span class="llm-status" id="status-mock">âœ… Toujours disponible</span>
        </label>
      </div>
      
      <div class="llm-option">
        <input type="radio" id="llm_ollama" name="llm_mode" value="ollama">
        <label for="llm_ollama" class="llm-label">
          <span class="llm-name">ğŸ¤– Ollama Local</span>
          <span class="llm-desc">IA locale, gratuit, plus intelligent</span>
          <span class="llm-status" id="status-ollama">â³ VÃ©rification...</span>
        </label>
      </div>
      
      <div class="llm-option">
        <input type="radio" id="llm_openai" name="llm_mode" value="openai">
        <label for="llm_openai" class="llm-label">
          <span class="llm-name">ğŸ§  OpenAI</span>
          <span class="llm-desc">TrÃ¨s intelligent, coÃ»t par usage</span>
          <span class="llm-status" id="status-openai">â³ VÃ©rification...</span>
        </label>
      </div>
    </div>
    
    <div class="form-actions">
      <button type="submit">ğŸ‘ï¸ PrÃ©visualiser</button>
      <button type="submit" formaction="/generate" class="btn-primary">ğŸš€ GÃ©nÃ©rer directement</button>
    </div>
    
    {% if error %}<p class="error">{{ error }}</p>{% endif %}
  </form>

  {% if projects %}
  <section class="recent-projects">
    <h3>ï¿½ Projets rÃ©cents</h3>
    <ul class="projects-list">
      {% for p in projects %}
        <li class="project-item">
          <div class="project-info">
            <strong>{{ p.name }}</strong>
            <span class="status-badge status-{{ p.status }}">{{ p.status }}</span>
            <small class="project-date">{{ p.created_at.strftime('%d/%m/%Y %H:%M') if p.created_at else '' }}</small>
          </div>
          <div class="project-actions">
            <a href="{{ url_for('download_zip', filename=(p.zip_path.split('/')[-1] if '/' in p.zip_path else p.zip_path.split('\\\\')[-1])) }}" class="btn-small">ğŸ“¦ ZIP</a>
            <form action="/push-image/{{ p.id }}" method="post" style="display:inline;">
              <button type="submit" class="btn-small btn-secondary">ğŸ³ Push</button>
            </form>
          </div>
          {% if p.prompt %}
          <div class="project-prompt">{{ p.prompt[:80] }}{% if p.prompt|length > 80 %}...{% endif %}</div>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  </section>
  {% endif %}

  <script>
    // VÃ©rifier le statut des LLM au chargement
    fetch('/api/llm-status')
      .then(response => response.json())
      .then(data => {
        // Mock
        document.getElementById('status-mock').textContent = 'âœ… Toujours disponible';
        
        // Ollama
        const ollamaStatus = document.getElementById('status-ollama');
        if (data.providers.ollama.available) {
          ollamaStatus.textContent = `âœ… Disponible (${data.providers.ollama.models ? data.providers.ollama.models.join(', ') : 'OK'})`;
          ollamaStatus.style.color = 'green';
        } else {
          ollamaStatus.textContent = `âŒ ${data.providers.ollama.error}`;
          ollamaStatus.style.color = 'red';
          document.getElementById('llm_ollama').disabled = true;
        }
        
        // OpenAI
        const openaiStatus = document.getElementById('status-openai');
        if (data.providers.openai.available) {
          openaiStatus.textContent = `âœ… ConfigurÃ© (${data.providers.openai.model})`;
          openaiStatus.style.color = 'green';
        } else {
          openaiStatus.textContent = `âŒ ${data.providers.openai.error}`;
          openaiStatus.style.color = 'red';
          document.getElementById('llm_openai').disabled = true;
        }
        
        // SÃ©lectionner le mode actuel si disponible
        if (data.current_mode && data.current_mode !== 'mock') {
          const currentRadio = document.getElementById(`llm_${data.current_mode}`);
          if (currentRadio && !currentRadio.disabled) {
            currentRadio.checked = true;
          }
        }
      })
      .catch(error => {
        console.error('Erreur vÃ©rification LLM:', error);
        document.getElementById('status-ollama').textContent = 'âŒ Erreur vÃ©rification';
        document.getElementById('status-openai').textContent = 'âŒ Erreur vÃ©rification';
      });
  </script>
{% endblock %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentForge - AI Orchestration Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="game-container">
        <!-- Header with orchestrator switching -->
        <header class="game-header">
            <div class="header-left">
                <h1>ü§ñ AgentForge</h1>
                <div class="version-toggle">
                    <span class="version-label">Orchestrator:</span>
                    <div class="toggle-switch">
                        <input type="radio" id="orch-v1" name="orchestrator" value="v1">
                        <label for="orch-v1">
                            <span class="version-name">v1</span>
                            <span class="version-desc">Graph Pipeline</span>
                        </label>
                        
                        <input type="radio" id="orch-v2" name="orchestrator" value="v2" checked>
                        <label for="orch-v2">
                            <span class="version-name">v2</span>
                            <span class="version-desc">21 AI Agents</span>
                        </label>
                    </div>
                </div>
            </div>
            
            <div class="header-right">
                <div class="system-stats">
                    <div class="stat-card">
                        <span class="stat-value">{{ stats.total if stats else 0 }}</span>
                        <span class="stat-label">Projects</span>
                    </div>
                    <div class="stat-card" id="llm-status">
                        <span class="stat-value">‚è≥</span>
                        <span class="stat-label">LLM Status</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Quick Actions Panel -->
        <section class="action-panel">
            <div class="quick-actions">
                <a href="/create" class="action-button primary">
                    <div class="action-icon">üöÄ</div>
                    <div class="action-text">
                        <span class="action-title">Create Project</span>
                        <span class="action-desc">Generate new AI-powered project</span>
                    </div>
                </a>
                
                <a href="/monitor" class="action-button secondary">
                    <div class="action-icon">üìä</div>
                    <div class="action-text">
                        <span class="action-title">Live Monitor</span>
                        <span class="action-desc">Watch agents in real-time</span>
                    </div>
                </a>
                
                <button class="action-button tertiary" onclick="refreshSystemStatus()">
                    <div class="action-icon">üîÑ</div>
                    <div class="action-text">
                        <span class="action-title">Refresh Status</span>
                        <span class="action-desc">Check system health</span>
                    </div>
                </button>
            </div>
        </section>

        <!-- Project Gallery -->
        <section class="project-gallery">
            <div class="gallery-header">
                <h2>üóÇÔ∏è Project Gallery</h2>
                <div class="gallery-controls">
                    <input type="search" id="search-projects" placeholder="Search projects..." class="search-input">
                    <select id="filter-status" class="filter-select">
                        <option value="">All Status</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                        <option value="running">Running</option>
                    </select>
                </div>
            </div>
            
            {% if projects %}
            <div class="projects-grid" id="projects-grid">
                {% for project in projects %}
                <div class="project-card" data-status="{{ project.status }}" data-name="{{ project.name.lower() }}">
                    <div class="card-header">
                        <div class="project-title">
                            <h3>{{ project.name }}</h3>
                            <span class="status-badge status-{{ project.status }}">{{ project.status }}</span>
                        </div>
                        <div class="project-date">
                            {{ project.created_at.strftime('%d/%m %H:%M') if project.created_at else 'Unknown' }}
                        </div>
                    </div>
                    
                    <div class="card-body">
                        <p class="project-prompt">{{ project.prompt[:120] }}{% if project.prompt|length > 120 %}...{% endif %}</p>
                        
                        <div class="project-actions">
                            {% if project.zip_path %}
                            <a href="{{ url_for('download_zip', filename=project.zip_path.split('/')[-1] if '/' in project.zip_path else project.zip_path.split('\\\\')[-1]) }}" 
                               class="action-btn download">
                                üì¶ Download
                            </a>
                            {% endif %}
                            
                            <button onclick="buildDocker('{{ project.id }}')" class="action-btn docker">
                                üê≥ Docker
                            </button>

                            <button onclick="viewLogs('{{ project.id }}')" class="action-btn logs">
                                üìã Logs
                            </button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-icon">üéØ</div>
                <h3>No projects yet</h3>
                <p>Create your first AI-generated project!</p>
                <a href="/create" class="btn-primary">Start Creating</a>
            </div>
            {% endif %}
        </section>
    </div>

    <!-- Modals -->
    <div id="logs-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Project Logs</h3>
                <span class="close" onclick="closeModal('logs-modal')">&times;</span>
            </div>
            <div class="modal-body">
                <pre id="logs-content"></pre>
            </div>
        </div>
    </div>

    <script>
        // Initialize system status check
        let systemStatus = {};
        
        async function checkSystemStatus() {
            try {
                // Check system capabilities
                const response = await fetch('/api/system-status');
                const status = await response.json();
                systemStatus = status;
                
                // Update orchestrator toggles availability
                const v1Toggle = document.getElementById('orch-v1');
                const v2Toggle = document.getElementById('orch-v2');
                
                if (!status.orchestrators.v1.available) {
                    v1Toggle.disabled = true;
                    v1Toggle.nextElementSibling.classList.add('disabled');
                }
                
                if (!status.orchestrators.v2.available) {
                    v2Toggle.disabled = true;
                    v2Toggle.nextElementSibling.classList.add('disabled');
                } else {
                    v2Toggle.checked = true; // Default to v2 if available
                }
                
                // Check LLM status
                const llmResponse = await fetch('/api/llm-status');
                const llmData = await llmResponse.json();
                
                const llmStatusEl = document.getElementById('llm-status');
                const availableCount = Object.values(llmData.providers).filter(p => p.available).length;
                
                llmStatusEl.querySelector('.stat-value').textContent = availableCount;
                llmStatusEl.querySelector('.stat-label').textContent = `LLM${availableCount > 1 ? 's' : ''} Ready`;
                
                // Update status indicator color
                if (availableCount > 1) {
                    llmStatusEl.className = 'stat-card status-good';
                } else if (availableCount === 1) {
                    llmStatusEl.className = 'stat-card status-warning';
                } else {
                    llmStatusEl.className = 'stat-card status-error';
                }
                
            } catch (error) {
                console.error('Error checking system status:', error);
                document.getElementById('llm-status').className = 'stat-card status-error';
                document.getElementById('llm-status').querySelector('.stat-value').textContent = '‚ùå';
                document.getElementById('llm-status').querySelector('.stat-label').textContent = 'Error';
            }
        }
        
        function refreshSystemStatus() {
            const button = event.target.closest('.action-button');
            const icon = button.querySelector('.action-icon');
            const originalIcon = icon.textContent;
            
            icon.innerHTML = '<div class="spinner"></div>';
            
            checkSystemStatus().finally(() => {
                setTimeout(() => {
                    icon.textContent = originalIcon;
                }, 1000);
            });
        }
        
        // Project filtering
        function filterProjects() {
            const searchTerm = document.getElementById('search-projects').value.toLowerCase();
            const statusFilter = document.getElementById('filter-status').value;
            const cards = document.querySelectorAll('.project-card');
            
            cards.forEach(card => {
                const name = card.dataset.name;
                const status = card.dataset.status;
                
                const matchesSearch = !searchTerm || name.includes(searchTerm);
                const matchesStatus = !statusFilter || status === statusFilter;
                
                card.style.display = matchesSearch && matchesStatus ? 'block' : 'none';
            });
        }
        
        document.getElementById('search-projects').addEventListener('input', filterProjects);
        document.getElementById('filter-status').addEventListener('change', filterProjects);
        
        // Docker build
        async function buildDocker(projectId) {
            try {
                const response = await fetch(`/api/docker/build/${projectId}`, {method: 'POST'});
                const result = await response.json();
                
                if (result.success) {
                    showMessage('Docker build started successfully!', 'success');
                } else {
                    showMessage(result.error || 'Docker build failed', 'error');
                }
            } catch (error) {
                showMessage('Docker build failed: ' + error.message, 'error');
            }
        }
        
        // View logs
        async function viewLogs(projectId) {
            try {
                const response = await fetch(`/api/project/${projectId}/logs`);
                if (!response.ok) {
                    throw new Error('Failed to load logs');
                }
                
                const logs = await response.json();
                
                document.getElementById('logs-content').textContent = 
                    Array.isArray(logs) ? 
                    logs.map(l => typeof l === 'string' ? l : JSON.stringify(l, null, 2)).join('\n') : 
                    JSON.stringify(logs, null, 2);
                
                document.getElementById('logs-modal').style.display = 'flex';
            } catch (error) {
                showMessage('Could not load logs: ' + error.message, 'error');
            }
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        function showMessage(text, type = 'info') {
            const messageEl = document.createElement('div');
            messageEl.className = `message ${type}`;
            messageEl.textContent = text;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 5000);
        }
        
        // Orchestrator switching
        document.querySelectorAll('input[name="orchestrator"]').forEach(input => {
            input.addEventListener('change', function() {
                if (this.checked) {
                    const version = this.value;
                    localStorage.setItem('preferred_orchestrator', version);
                    showMessage(`Switched to Orchestrator ${version.toUpperCase()}`, 'info');
                }
            });
        });
        
        // Restore preferred orchestrator
        const preferred = localStorage.getItem('preferred_orchestrator');
        if (preferred) {
            const toggle = document.getElementById(`orch-${preferred}`);
            if (toggle && !toggle.disabled) {
                toggle.checked = true;
            }
        }
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', checkSystemStatus);
    </script>
</body>
</html>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center">
                    <div class="p-2 bg-yellow-100 rounded-lg">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Avg. Time</p>
                        <p class="text-2xl font-semibold text-gray-900">2.5min</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Project Gallery -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-semibold text-gray-900">Generated Projects</h2>
                <p class="text-sm text-gray-600">Download and explore AI-generated applications</p>
            </div>
            
            <div class="p-6">
                {% if projects %}
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    {% for project in projects %}
                    <div class="border rounded-lg p-4 hover:shadow-md transition-shadow">
                        <div class="flex items-start justify-between mb-3">
                            <div class="flex items-center space-x-2">
                                <i class="fas fa-folder text-blue-500"></i>
                                <h3 class="font-medium text-gray-900 truncate">{{ project.name }}</h3>
                            </div>
                            <span class="bg-{{ 'green' if project.orchestrator_version == 'v2' else 'blue' }}-100 text-{{ 'green' if project.orchestrator_version == 'v2' else 'blue' }}-800 text-xs px-2 py-1 rounded">
                                {{ project.orchestrator_version or 'v1' }}
                            </span>
                        </div>
                        
                        <p class="text-sm text-gray-600 mb-3 line-clamp-2">
                            {{ project.description or 'No description' }}
                        </p>
                        
                        <div class="flex items-center justify-between text-xs text-gray-500 mb-3">
                            <span><i class="fas fa-calendar"></i> {{ project.created_at.strftime('%Y-%m-%d') if project.created_at else 'Unknown' }}</span>
                            <span><i class="fas fa-file-code"></i> Files: {{ project.file_count or 'N/A' }}</span>
                        </div>
                        
                        <div class="flex space-x-2">
                            <a href="/download/{{ project.id }}" 
                               class="flex-1 bg-blue-600 text-white text-sm px-3 py-2 rounded hover:bg-blue-700 text-center">
                                <i class="fas fa-download mr-1"></i> Download
                            </a>
                            <button onclick="previewProject('{{ project.id }}')" 
                                    class="bg-gray-100 text-gray-700 text-sm px-3 py-2 rounded hover:bg-gray-200">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-12">
                    <i class="fas fa-folder-open text-4xl text-gray-300 mb-4"></i>
                    <p class="text-gray-500">No projects generated yet</p>
                    <a href="/create" class="mt-4 inline-block bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                        Create Your First Project
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </main>

    <script>
        // Initialize Socket.IO
        const socket = io();
        
        socket.on('connect', function() {
            console.log('Connected to AgentForge Monitor');
        });
        
        function previewProject(projectId) {
            // TODO: Implement project preview modal
            alert(`Preview project ${projectId} - Coming soon!`);
        }
        
        // Update stats in real-time
        socket.on('stats_update', function(data) {
            document.getElementById('llm-calls').textContent = data.llm_calls || 0;
        });
    </script>
</body>
</html>
